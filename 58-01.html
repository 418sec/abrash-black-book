<HTML>
<HEAD>
<META name=vsisbn content="1576101746">
<META name=vstitle content="Michael Abrash's Graphics Programming Black Book, Special Edition">
<META name=vsauthor content="Michael Abrash">
<META name=vspublisher content="The Coriolis Group">
<META name=vspubdate content="07/01/97">
<META name=vscategory content="Web and Software Development: Game Development,Web and Software Development: Graphics and Multimedia Development">






<TITLE>Michael Abrash's Graphics Programming Black Book Special Edition: Heinlein's Crystal Ball, Spock's Brain, and the 9-Cycle Dare</TITLE>

<!-- HEADER -->
<!-- Empty Reference Subhead -->

<!--ISBN=1576101746//-->
<!--TITLE=Michael Abrash's Graphics Programming Black Book Special Edition//-->
<!--AUTHOR=Michael Abrash//-->
<!--PUBLISHER=The Coriolis Group, Inc.//-->
<!--CHAPTER=58//-->
<!--PAGES=1077-1081//-->
<!--UNASSIGNED1//-->
<!--UNASSIGNED2//--></HEAD><BODY LINK=#0000FF ALINK=#000099 VLINK=#0000FF BGCOLOR=#FFFFFF>

<CENTER>
<TABLE BORDER>
<TR>
<TD><A HREF="57-04.html">Previous</A></TD>
<TD><A HREF="index.html">Table of Contents</A></TD>
<TD><A HREF="58-02.html">Next</A></TD>
</TR>
</TABLE>
</CENTER>
<P><BR></P>
<H2><A NAME="Heading1"></A><FONT COLOR="#000077">Chapter 58<BR>Heinlein&#146;s Crystal Ball, Spock&#146;s Brain, and the 9-Cycle Dare
</FONT></H2>
<H3><A NAME="Heading2"></A><FONT COLOR="#000077">Using the Whole-Brain Approach to Accelerate Texture Mapping</FONT></H3>
<P>I&#146;ve had the pleasure recently of rereading several of the works of Robert A. Heinlein, and I&#146;m as impressed as I was as a teenager&#151;but in a different way. The first time around, I was wowed by the sheer romance of technology married to powerful stories; this time, I&#146;m struck most of all by The Master&#146;s remarkable prescience. &#147;Blowups Happen&#148; is about the risks of nuclear power, and their effects on human psychology&#151;written before a chain reaction had ever happened on this planet. &#147;Solution Unsatisfactory&#148; is about the unsolvable dilemma&#151;ultimate offense, no defense&#151;posed by atomic weapons; this in 1941. And in <I>Between Planets</I> (1951), consider this minor bit of action:</P>
<BLOCKQUOTE><P>The doctor&#146;s phone regretted politely that Dr. Jefferson was not at home and requested him to leave a message. He was dictating it when a warm voice interrupted: &#145;I&#146;m at home to you, Donald. Where are you, lad?&#146;
</P>
</BLOCKQUOTE><P>Predicting the widespread use of answering machines is perhaps not so remarkable, but foreseeing that they would be used for call screening is; technology is much easier to extrapolate than are social patterns.
</P>
<P>Even so, Heinlein was no prophet; his crystal ball was just a little less fuzzy than ours. The aforementioned call in <I>Between Planets</I> was placed on a viewphone; while that technology has indeed come to pass, its widespread use has not. The ultimate weapon in &#147;Solution Unsatisfactory&#148; was radioactive dust, not nuclear bombs, and we have somehow survived nearly 50 years of nuclear weapons without either acquiring a world dictator or destroying ourselves. Slide rules are all over the place in Heinlein&#146;s works, and in one story (the name now lost to memory), an astronaut straps himself into a massive integral calculator; computers are nowhere to be found.</P>
<P>Most telling, I think, is that in &#147;Blowups Happen,&#148; the engineers running the nuclear power plant&#151;at considerable risk to both body and sanity&#151;are the best of the best, highly skilled in math and required to ride the nuclear reaction on a second-to-second basis, with the risk of an explosion that might end life on Earth, and would surely kill them, if they slip. Contrast that with our present-day reality of nuclear plants run by generally competent technicians, with the occasional report of shoddy maintenance and bored power-plant employees using drugs, playing games, and falling asleep while on duty. Heinlein&#146;s universe makes for a better story, of course, but, more than that, it shows the filters and biases through which he viewed the world. At least in print, Heinlein was an unwavering believer in science, technology, and rationality, and in his stories it is usually the engineers and scientists who are the heroes and push civilization forward, often kicking and screaming. In the real world, I have rarely observed that to be the case.</P>
<P>But of course Heinlein was hardly the only person to have his or her perceptions of the universe, past, present, or future, blurred by his built-in assumptions; you and I, as programmers, are also on that list&#151;and probably pretty near the top, at that. Performance programming is basically a process of going from the general to the specific, special-casing the code so that it does just what it has to, and no more. The greatest impediment to this process is seeing the problem in terms of what the code currently does, or what you already know, thereby ignoring many possible solutions. Put another way, how you look at an optimization problem determines how you&#146;ll solve it; your assumptions may speed and simplify the process, but they are also your limitations. Consider, for example, how a seemingly intractable problem becomes eminently tractable the instant you learn that someone else has solved it.</P>
<P>As Exhibit #1, I present my experience with speeding up the texture mapper in X-Sharp.</P>
<H3><A NAME="Heading3"></A><FONT COLOR="#000077">Texture Mapping Redux</FONT></H3>
<P>We&#146;ve spent the previous several chapters exploring the X Sharp graphics library, something I built over time as a serious exercise in 3-D graphics. When X-Sharp reached the point at which we left it at the end of the previous chapter, I was rather pleased with it&#151;with one exception.
</P>
<P>My last addition to X-Sharp was a <I>texture mapper,</I> a routine that warped and rotated any desired bitmap to map onto an arbitrary convex polygon. Texture mappers are critical to good 3-D games; just a few texture-mapped polygons, backed with well-drawn bitmaps, can represent more detail and look more realistic than dozens or even hundreds of solid-color polygons. My X-Sharp texture mapper was in reasonable assembly&#151;pretty good code, by most standards!&#151;and I felt comfortable with my implementation; but then I got a letter from John Miles, who was at the time getting seriously into 3-D and is now the author of a 3-D game library. (Yes, you can license it from his company, Non-Linear Arts, if you&#146;d like; John can be reached at 70322.2457@compuserve.com.) John wrote me as follows: &#147;Hmm, so <I>that&#146;s</I> how texture-mapping works. But 3 jumps <I>per pixel?</I> Hmph!&#148;</P>
<P>It was the &#147;Hmph&#148; that really got to me.</P>
<H4 ALIGN="LEFT"><A NAME="Heading4"></A><FONT COLOR="#000077">Left-Brain Optimization</FONT></H4>
<P>That was the first shot of juice for my optimizer (or at least blow to my ego, which can be just as productive). John went on to say he had gotten texture mapping down to 9 cycles per pixel and one jump per <I>scanline</I> on a 486 (all cycle times will be for the 486 unless otherwise noted); given that my code took, on average, about 44 cycles and 2 taken jumps (plus 1 not taken) per pixel, I had a long way to go.</P>
<P>The inner loop of my original texture-mapping code is shown in Listing 58.1. All this code does is draw a single texture-mapped scanline, as shown in Figure 58.1; an outer loop runs through all the scanlines in whatever polygon is being drawn. I immediately saw that I could eliminate nearly 10 percent of the cycles by unrolling the loop; obviously, John had done that, else there&#146;s no way he could branch only once per scanline. (By the way, branching only once per scanline via a fully unrolled loop is not generally recommended. A branch every few pixels costs relatively little, and the cache effects of fully unrolled code are <I>not</I> good.) I quickly came up with several other ways to speed up the code, but soon realized that all the clever coding in the world wasn&#146;t going to get me within 100 percent of John&#146;s performance so long as I had to cycle from one plane to the next for every pixel.</P>
<P><A NAME="Fig1"><!-- </A><A HREF="javascript:displayWindow('images/58-01.jpg',408,174 )"> --><IMG SRC="images/58-01.jpg"><BR><!-- </A>
<BR><A HREF="javascript:displayWindow('images/58-01.jpg',408,174)"> --><FONT COLOR="#000077"><B>Figure 58.1</B></FONT></A>&nbsp;&nbsp;<I>Texture mapping a single horizontal scanline.</I>
<P><BR></P>
<CENTER>
<TABLE BORDER>
<TR>
<TD><A HREF="57-04.html">Previous</A></TD>
<TD><A HREF="index.html">Table of Contents</A></TD>
<TD><A HREF="58-02.html">Next</A></TD>
</TR>
</TABLE>
</CENTER>

<hr width="90%" size="1" noshade>
<div align="center">
<font face="Verdana,sans-serif" size="1">Graphics Programming Black Book &copy; 2001 Michael Abrash</font>
</div>
<!-- all of the reference materials (books) have the footer and subfoot reveresed -->
<!-- reference_subfoot = footer -->
<!-- reference_footer = subfoot -->

<!-- BEGIN SUB FOOTER -->
</BODY>
</HTML>

<!-- END FOOTER -->


