<HTML>
<HEAD>
<META name=vsisbn content="1576101746">
<META name=vstitle content="Michael Abrash's Graphics Programming Black Book, Special Edition">
<META name=vsauthor content="Michael Abrash">
<META name=vspublisher content="The Coriolis Group">
<META name=vspubdate content="07/01/97">
<META name=vscategory content="Web and Software Development: Game Development,Web and Software Development: Graphics and Multimedia Development">






<TITLE>Michael Abrash's Graphics Programming Black Book Special Edition: Unleashing the Pentium's</TITLE>

<!-- HEADER -->
<!-- Empty Reference Subhead -->

<!--ISBN=1576101746//-->
<!--TITLE=Michael Abrash's Graphics Programming Black Book Special Edition//-->
<!--AUTHOR=Michael Abrash//-->
<!--PUBLISHER=The Coriolis Group, Inc.//-->
<!--CHAPTER=21//-->
<!--PAGES=397-402//-->
<!--UNASSIGNED1//-->
<!--UNASSIGNED2//--></HEAD><BODY LINK=#0000FF ALINK=#000099 VLINK=#0000FF BGCOLOR=#FFFFFF>

<CENTER>
<TABLE BORDER>
<TR>
<TD><A HREF="../ch20/20-04.html">Previous</A></TD>
<TD><A HREF="../index.html">Table of Contents</A></TD>
<TD><A HREF="21-02.html">Next</A></TD>
</TR>
</TABLE>
</CENTER>
<P><BR></P>
<H2><A NAME="Heading1"></A><FONT COLOR="#000077">Chapter 21<BR>Unleashing the Pentium&#146;s V-Pipe
</FONT></H2>
<H3><A NAME="Heading2"></A><FONT COLOR="#000077">Focusing on Keeping Both Pentium Pipes Full</FONT></H3>
<P>The other day, my daughter suggested that we each draw the prettiest picture we could, then see whose was prettier. I won&#146;t comment on who won, except to note that apparently a bolt of lightning zipping toward a moose with antlers that bear an unfortunate resemblance to a propeller beanie isn&#146;t going to win me any scholarships to art school, if you catch my drift. Anyway, my drawing happened to feature the word &#147;chartreuse&#148; (because it rhymed with &#147;moose&#148; and &#147;Zeus&#148;&#151;hence the lightning; more than that I am not at liberty to divulge), and she wanted to know if the moose was actually chartreuse. I had to admit that I didn&#146;t know, so we went to the dictionary, whereupon we learned that chartreuse is a pale apple-green color. Then she brought up the Windows Control Panel, pointed to the selection of predefined colors, and asked, &#147;Which of those is chartreuse?&#148;&#151;and I realized that I <I>still</I> didn&#146;t know.</P>
<P>Some things can be described perfectly with words, but others just have to be experienced. Color is one such category, and Pentium optimization is another. I&#146;ve spent the last two chapters detailing the rules for Pentium optimization, and I&#146;ll spend half of this one doing so, as well. That&#146;s good; without understanding the fundamentals, we have no chance of optimizing well. It&#146;s not enough, though. We also need to look at a real-world example of Pentium optimization in action, and we&#146;ll do that later in this chapter; after which, you should go out and do some Pentium optimization on your own. Optimization is one of those things that you can learn a lot about from reading, but ultimately it has to sink into your pores as you do it&#151;especially Pentium optimization because the Pentium is perhaps the most complex (and rewarding) chip to optimize for that I&#146;ve ever seen.</P>
<P>In the last chapter, we explored the dual-execution-pipe nature of the Pentium, and learned which instructions could pair (execute simultaneously) in which pipes. Now we&#146;re ready to look at AGIs and register contention&#151;two hazards that can prevent otherwise properly written code from taking full advantage of the Pentium&#146;s two pipes, and can thereby keep your code from pushing the Pentium to maximum performance.</P>
<H3><A NAME="Heading3"></A><FONT COLOR="#000077">Address Generation Interlocks</FONT></H3>
<P>The Pentium is advertised as having a five-stage pipeline for each of its execution units. All this means is that at any given time, up to five instructions are in various stages of execution in each pipe; this overlapping of execution is done for speed, so each instruction doesn&#146;t have to wait until the previous one has finished. The only way that the Pentium&#146;s pipelining directly affects the way you program is in the areas of AGIs and register dependencies.
</P>
<P>AGIs are <I>Address Generation Interlocks</I>, a fancy way of saying that if a register is used to address memory, as is EBX in this instruction</P>
<!-- CODE SNIP //-->
<PRE>
mov [ebx],eax
</PRE>
<!-- END CODE SNIP //-->
<P>and the value of the register is not set far enough ahead for the Pentium to perform the addressing calculations before the instruction needs the address, then the Pentium will stall the pipe in which the instruction is executing until the value becomes available and the addressing calculations have been performed. Remember, also, that instructions execute in lockstep on the Pentium, so if one pipe stalls for a cycle, making its instruction take one cycle longer, that extends by one cycle the time until the other pipe can begin its next instruction, as well.
</P>
<P>The rule for AGIs is simple: If you modify any part of a register during a cycle, you cannot use that register to address memory during either that cycle or the next cycle. If you try to do this, the Pentium will simply stall the instruction that tries to use that register to address memory until two cycles after the register was modified. This was true on the 486 as well, but the Pentium&#146;s new twist is that since more than one instruction can execute in a single cycle, an AGI can stall an instruction that&#146;s as many as three instructions away from the changing of the addressing register, as shown in Figure 21.1, and an AGI can also cause a stall that costs as many as three instructions, as shown in Figure 21.2. This means that AGIs are both much easier to cause and potentially more expensive than on the 486, and you must keep a sharp eye out for them. It also means that it&#146;s often worth calculating a memory pointer several instructions ahead of its actual use. Unfortunately, this tends to extend the lifetimes of pointer registers to span a greater number of instructions, making the Pentium&#146;s relatively small register set seem even smaller.</P>
<P><A NAME="Fig1"><!-- </A><A HREF="javascript:displayWindow('images/21-01.jpg',414,341 )"> --><IMG SRC="images/21-01.jpg"><BR><!-- </A>
<BR><A HREF="javascript:displayWindow('images/21-01.jpg',414,341)"> --><FONT COLOR="#000077"><B>Figure 21.1</B></FONT></A>&nbsp;&nbsp;<I>An AGI can stall up to three instructions later.</I>
</P>
<P>As an example of a sort of AGI that&#146;s new to the Pentium, consider the following test for a NULL pointer, followed by the use of the pointer if it&#146;s not NULL:
</P>
<!-- CODE SNIP //-->
<PRE>
push ebx          ;U-pipe cycle 1
mov  ebx,[Ptr]    ;V-pipe cycle 1
and  ebx,ebx      ;U-pipe cycle 2
jz   short IsNull ;V-pipe cycle 2
mov  eax,[ebx]    ;U-pipe cycle 3 AGI stall
mov  edx,[ebp-8]  ;V-pipe cycle 3 lockstep idle
                  ;U-pipe cycle 4 mov eax,[ebx]
                  ;V-pipe cycle 4 mov edx,[ebp-8]
</PRE>
<!-- END CODE SNIP //-->
<P>This commonplace code loses a U-pipe cycle to the AGI caused by <B>AND EBX,EBX</B>, followed by the attempt two instructions later to use EBX to point to memory. The code loses a V-pipe cycle as well, because lockstep execution won&#146;t let the next V-pipe instruction execute until the paired U-pipe instruction that suffered the AGI finishes. The solution is to use <B>TEST EBX,EBX</B> instead of <B>AND; TEST</B> can&#146;t modify EBX, so no AGI occurs. Sure, <B>AND EBX,EBX</B> doesn&#146;t modify EBX either, but the Pentium doesn&#146;t know that, so it has to insert the AGI.</P>
<P><A NAME="Fig2"><!-- </A><A HREF="javascript:displayWindow('images/21-02.jpg',407,342 )"> --><IMG SRC="images/21-02.jpg"><BR><!-- </A>
<BR><A HREF="javascript:displayWindow('images/21-02.jpg',407,342)"> --><FONT COLOR="#000077"><B>Figure 21.2</B></FONT></A>&nbsp;&nbsp;<I>An AGI can cost as many as 3 cycles.</I>
<P><BR></P>
<CENTER>
<TABLE BORDER>
<TR>
<TD><A HREF="../ch20/20-04.html">Previous</A></TD>
<TD><A HREF="../index.html">Table of Contents</A></TD>
<TD><A HREF="21-02.html">Next</A></TD>
</TR>
</TABLE>
</CENTER>

<hr width="90%" size="1" noshade>
<div align="center">
<font face="Verdana,sans-serif" size="1">Graphics Programming Black Book &copy; 2001 Michael Abrash</font>
</div>
<!-- all of the reference materials (books) have the footer and subfoot reveresed -->
<!-- reference_subfoot = footer -->
<!-- reference_footer = subfoot -->

<!-- BEGIN SUB FOOTER -->
</BODY>
</HTML>

<!-- END FOOTER -->


